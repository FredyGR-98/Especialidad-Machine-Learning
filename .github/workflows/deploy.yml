name: CI - Breast Cancer API

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout del repositorio
      uses: actions/checkout@v4

    - name: 🐍 Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: 📦 Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/api.txt -r requirements/common.txt

    - name: 🔧 Entrenar modelo
      run: python train_model.py

    - name: 🚀 Iniciar API en background
      run: |
        nohup python api.py > server.log 2>&1 &
        # Esperar a que levante (hasta ~20s)
        for i in {1..20}; do
          if curl -sSf http://127.0.0.1:5000/ >/dev/null; then
            echo "API arriba ✅"
            break
          fi
          sleep 1
        done
        echo "---- server.log (últimas líneas) ----"
        tail -n 50 server.log || true

    - name: 🧪 Ejecutar pruebas automáticas
      run: python test_api.py